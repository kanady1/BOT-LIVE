<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>لوحة تداول لايف (Binance WS)</title>
<style>
  :root{--bg:#0b1220;--panel:#0f1724;--line:#16202b;--text:#dfe7ef}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Tahoma}
  header{display:flex;gap:8px;align-items:center;padding:10px;background:var(--panel);border-bottom:1px solid var(--line)}
  header h1{font-size:16px;margin:0}
  select,input,button{background:#0c1626;color:var(--text);border:1px solid var(--line);border-radius:6px;padding:6px 8px}
  button.primary{background:#12314e}
  .wrap{padding:10px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
  #chart{height:520px}
  #rsi{height:120px;margin-top:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{background:#0b1a2a;border:1px solid var(--line);padding:4px 8px;border-radius:999px;font-size:12px;margin:2px}
</style>
</head>
<body>
<header>
  <h1>لوحة تداول لايف</h1>
  <select id="symbol"><option>BTCUSDT</option><option>ETHUSDT</option></select>
  <select id="interval">
    <option value="1m">1m</option><option value="3m">3m</option>
    <option value="5m">5m</option><option value="15m" selected>15m</option><option value="30m">30m</option>
  </select>
  <select id="strategy">
    <option value="trend">#1 TrendSwitch (Donchian+RSI)</option>
    <option value="swing">#2 Swing Peaks/Troughs</option>
    <option value="monthly">#3 Monthly Swing</option>
  </select>
  <label><input type="checkbox" id="real"/> تنفيذ حقيقي</label>
  <input id="qty" type="number" step="0.01" value="50" title="quoteOrderQty USDT" style="width:110px">
  <button id="start" class="primary">تشغيل</button>
  <button id="stop">إيقاف</button>
</header>

<div class="wrap">
  <div class="row">
    <div class="chip">الحالة: <span id="conn">متوقف</span></div>
    <div class="chip">RSI: <span id="rsiVal">—</span></div>
    <div class="chip">دعم/مقاومة: <span id="dc">—</span></div>
    <div class="chip">آخر إشارة: <span id="sig">—</span></div>
  </div>

  <div class="card">
    <div id="chart"></div>
    <div id="rsi"></div>
    <div style="font-size:12px;opacity:.8;margin-top:6px">
      ⚠ عند تفعيل “تنفيذ حقيقي” تُرسل أوامر MARKET إلى <code>/api/order</code>. خزّن مفاتيحك في إعدادات Vercel وليس في الصفحة.
    </div>
  </div>
</div>

<script type="module">
  import { createChart } from 'https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.esm.production.js';

  const $=s=>document.querySelector(s);
  function fmt(n,d=2){return n!=null?Number(n).toFixed(d):'—';}

  const chart = createChart($('#chart'),{
    layout:{background:{type:'solid',color:'#071021'},textColor:'#dfe7ef'},
    rightPriceScale:{borderVisible:false},
    timeScale:{borderVisible:false,timeVisible:true,secondsVisible:false},
    grid:{vertLines:{color:'#0b1726'},horzLines:{color:'#0b1726'}},
    autoSize:true
  });
  const cs = chart.addCandlestickSeries({
    upColor:'#26a69a',downColor:'#ef5350',borderUpColor:'#26a69a',borderDownColor:'#ef5350',wickUpColor:'#26a69a',wickDownColor:'#ef5350'
  });
  const dcTop=chart.addLineSeries({color:'#f5a142',lineWidth:2});
  const dcBot=chart.addLineSeries({color:'#3aa0ff',lineWidth:2});

  const rsiChart = createChart($('#rsi'),{
    layout:{background:{type:'solid',color:'#061425'},textColor:'#c8d6e5'},
    rightPriceScale:{borderVisible:false},timeScale:{borderVisible:false,timeVisible:true,secondsVisible:false},
    grid:{vertLines:{color:'#0b1726'},horzLines:{color:'#0b1726'}},autoSize:true
  });
  const rsiLine=rsiChart.addLineSeries({color:'#8bc34a',lineWidth:2});
  const r30=rsiChart.addLineSeries({color:'#3a5',lineWidth:1});
  const r70=rsiChart.addLineSeries({color:'#a53',lineWidth:1});

  let ws=null, data=[];
  const rsiLen=14, donLen=20;

  function rsi(vals,len){
    if(vals.length<len+1) return null;
    let gains=0,loss=0;
    for(let i=vals.length-len;i<vals.length;i++){
      const ch=vals[i]-vals[i-1]; if(ch>0) gains+=ch; else loss-=ch;
    }
    if(loss===0) return 100;
    const rs=(gains/len)/(loss/len);
    return 100-(100/(1+rs));
  }
  function donchian(arr,len){
    if(arr.length<len) return null;
    let hi=-Infinity, lo=Infinity;
    for(let i=arr.length-len;i<arr.length;i++){hi=Math.max(hi,arr[i].high);lo=Math.min(lo,arr[i].low);}
    return {upper:hi, lower:lo};
  }

  async function fetchKlines(symbol, interval, limit=500){
    const u=https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit};
    const j=await (await fetch(u)).json();
    return j.map(a=>({time:Math.floor(a[0]/1000),open:+a[1],high:+a[2],low:+a[3],close:+a[4]}));
  }

  function render(){
    cs.setData(data);
    const closes=data.map(k=>k.close);
    const r=rsi(closes,rsiLen);
    if(r){
      $('#rsiVal').textContent=fmt(r);
      rsiLine.setData(data.map((k,i)=>({time:k.time,value:(i>0?rsi(closes.slice(0,i+1),rsiLen)||50:50)})));
      r30.setData(data.map(k=>({time:k.time,value:30})));
      r70.setData(data.map(k=>({time:k.time,value:70})));
    }
    const dc=donchian(data,donLen);
    if(dc){
      $('#dc').textContent=${fmt(dc.lower)} / ${fmt(dc.upper)};
      dcTop.setData(data.map(k=>({time:k.time,value:dc.upper})));
      dcBot.setData(data.map(k=>({time:k.time,value:dc.lower})));
    }
  }

  async function restBootstrap(){ data = await fetchKlines($('#symbol').value,$('#interval').value,500); render(); }

  $('#start').onclick = async ()=>{
    if(ws){ try{ws.close()}catch{} ws=null; }
    $('#conn').textContent='يتصل…';
    await restBootstrap();
    const s=$('#symbol').value.toLowerCase();
    const i=$('#interval').value;
    ws = new WebSocket(wss://stream.binance.com:9443/ws/${s}@kline_${i});
    ws.onopen=()=>$('#conn').textContent='متصل';
    ws.onclose=()=>$('#conn').textContent='منقطع';
    ws.onerror=()=>$('#conn').textContent='خطأ';
    ws.onmessage=(ev)=>{
      const d=JSON.parse(ev.data); if(!d.k) return;
      const k=d.k;
      const c={time:Math.floor(k.t/1000),open:+k.o,high:+k.h,low:+k.l,close:+k.c};
      if(data.length && data[data.length-1].time===c.time) data[data.length-1]=c; else data.push(c);
      render();
      // مثال بسيط لإشارة مبكرة: أول إغلاق فوق/تحت القناة + RSI فلتر
      const dc=donchian(data,donLen), last=data[data.length-1];
      const rr=rsi(data.map(x=>x.close),rsiLen);
      if(dc&&rr&&k.x){ // فقط عند إغلاق الشمعة
        if(last.close>dc.upper && rr>50){ cs.setMarkers([{time:last.time,position:'belowBar',color:'green',shape:'arrowUp',text:'BUY'}]); $('#sig').textContent=BUY @ ${fmt(last.close)}; }
        if(last.close<dc.lower && rr<50){ cs.setMarkers([{time:last.time,position:'aboveBar',color:'red',shape:'arrowDown',text:'SELL'}]); $('#sig').textContent=SELL @ ${fmt(last.close)}; }
      }
    };
  };

  $('#stop').onclick = ()=>{ if(ws){ try{ws.close()}catch{} ws=null; } $('#conn').textContent='متوقف'; };
</script>
</body>
</html>
